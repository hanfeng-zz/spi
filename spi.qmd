# SPI 快速概览
Developed by Motorola in the mid 1980’s

![SPI](spi.png) 

## 术语
|||
|----|----| 
|SPI|Serial Parallel Interface|
|SS|Slave Select|
|SCK| Serial Clock|
|MOSI |Master Output, Slave Input|
|MISO |Master Input, Slave Output|
|MOMI |Master Output, Master Input|
|SISO |Slave Input, Slave Output|
|CPOL|Clock Polarity|
|CPHA|Clock Phase|

## 基本组成
| 信号                                       | 方向    | 作用            |
| ---------------------------------------- | ----- | ------------- |
| **MOSI** (Master Out, Slave In)          | 主 → 从 | 主设备发送数据给从设备   |
| **MISO** (Master In, Slave Out)          | 从 → 主 | 从设备发送数据给主设备   |
| **SCLK** (Serial Clock)                  | 主 → 从 | 主设备提供时钟同步数据传输 |
| **CS / SS** (Chip Select / Slave Select) | 主 → 从 | 选择从设备，低电平有效   |


## 模式
| 模式         | CPOL | CPHA | 空闲时钟 | 采样边沿 |
| ---------- | ---- | ---- | ---- | ---- |
| **Mode 0** | 0    | 0    | 低电平  | 上升沿  |
| **Mode 1** | 0    | 1    | 低电平  | 下降沿  |
| **Mode 2** | 1    | 0    | 高电平  | 下降沿  |
| **Mode 3** | 1    | 1    | 高电平  | 上升沿  |

## 数据传输特性

- 全双工：MOSI/MISO 同时传输
- 同步传输：数据与时钟同步
- 字节长度可配置：通常 8 位，可扩展为 16/32 位

## 通信流程(主机发起)

1. 初始化 SPI 控制器
    - 设置 模式：CPOL/CPHA
    - 设置 时钟频率
    - 设置 字长（8-bit / 16-bit）
    - 配置 CS 控制方式（硬件或软件）

2. 拉低片选 CS
    - 表示选择某个从设备
    - SPI 从设备看到 CS 低电平才开始响应数据

3. 发送命令/地址（可选）
    - 对于 SPI Flash 或传感器，通常先发送命令字节（opcode）
    - 可能还需要发送地址或参数

4. 数据传输
    - 每个 SCLK 时钟周期传输一位
    - CPOL/CPHA 决定采样时机
    - 数据同时在 MOSI 和 MISO 上传输
    - 多字节数据连续发送

5. 接收数据
    - 从设备在 MISO 输出数据
    - 主设备在 MOSI 输出数据
    - 全双工特性：发送一个字节可以同时接收一个字节

6. 结束传输
    - 拉高 CS
    - SPI 控制器进入等待/空闲状态

7. 后处理
    - 软件读取接收缓冲区的数据
    - 根据协议解析命令或数据


## 优势
1. 速度快
    - SPI 是全双工、硬件驱动的串行总线。
    - 相比 I²C（标准 100kHz / Fast 400kHz / Fast+ 1MHz / HighSpeed 3.4MHz），SPI 常见工作频率能到 几 MHz ~ 数十 MHz，部分高速器件甚至支持 100+ MHz。

2. 协议简单
    - 没有复杂的仲裁、地址寻址（像 I²C 那样），只需要 时钟 (SCLK)、主机数据输出 (MOSI)、主机数据输入 (MISO)、片选 (CS) 四根线就能直接通信。

3. 全双工通信
    - 主机发送的同时，可以接收从机数据（MOSI / MISO 独立）。
    - 多从机支持
    - 通过多个片选 (CS) 管脚，可以挂载多个设备，主机灵活控制。

4. 硬件支持广泛
    - 几乎所有 MCU、SoC、FPGA 都带有 SPI 控制器，软件库和驱动丰富。



## 劣势
1. 片选线扩展性差
    - 每增加一个从机，就要增加一根 CS 信号线。
    - 如果从机数量多，主机 I/O 引脚会很快不够用。

2. 无标准协议层
    - SPI 只有物理层定义（时钟、极性、相位等），<mark/>没有标准的数据帧结构、校验机制、设备寻址</mark>。
    - 不同芯片的 SPI 协议细节可能不兼容，需要看具体 datasheet。

3. 线缆长度有限
    - 通常只能稳定在 几十厘米 内通信，长距离容易受到干扰。
    - I²C、CAN、RS-485 在总线和抗干扰上更适合长距离。

4. 主从关系固定
    - SPI 必须有一个主机驱动时钟，从机不能主动通信。
    - 不像 I²C，任意设备可请求总线。

5. 功耗略高
    - 因为全双工和高速时钟，功耗比 I²C 大。